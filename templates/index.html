<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-JSON Visual Editor</title>
    <meta name="description" content="Professional JSON editor with tree view, real-time editing, and multi-file support">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            font-family: 'JetBrains Mono', monospace;
        }
        
        body {
            background: #0a0e27;
            color: #e4e7eb;
            margin: 0;
            padding: 0;
        }

        .json-key { color: #66d9ef; }
        .json-string { color: #a6e22e; }
        .json-number { color: #fd971f; }
        .json-boolean { color: #f92672; }
        .json-null { color: #75715e; }
        
        .tree-node {
            margin-left: 20px;
            transition: all 0.2s ease;
        }
        
        .tree-toggle {
            cursor: pointer;
            user-select: none;
            display: inline-block;
            width: 16px;
            color: #66d9ef;
        }
        
        .tree-value {
            display: inline-block;
            margin-left: 5px;
        }
        
        .editable:hover {
            background: rgba(102, 217, 239, 0.1);
            cursor: text;
        }
        
        input.inline-edit {
            background: #1a1f3a;
            border: 1px solid #66d9ef;
            color: #e4e7eb;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            font-family: 'JetBrains Mono', monospace;
        }

        .btn-primary {
            background: #66d9ef;
            color: #0a0e27;
        }

        .btn-primary:hover {
            background: #54c7dd;
        }

        .btn-secondary {
            background: #1a1f3a;
            color: #66d9ef;
            border: 1px solid #66d9ef;
        }

        .btn-secondary:hover {
            background: rgba(102, 217, 239, 0.1);
        }

        .btn-danger {
            background: #f92672;
            color: white;
        }

        .btn-danger:hover {
            background: #e71560;
        }

        .toolbar {
            background: #0f1629;
            border-bottom: 1px solid #1a1f3a;
            padding: 16px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-input {
            background: #1a1f3a;
            border: 1px solid #2a2f4a;
            color: #e4e7eb;
            padding: 8px 12px;
            border-radius: 6px;
            flex: 1;
            min-width: 200px;
            font-family: 'JetBrains Mono', monospace;
        }

        .json-card {
            background: #0f1629;
            border: 1px solid #1a1f3a;
            border-radius: 8px;
            padding: 16px;
            height: 100%;
            overflow: auto;
        }

        .json-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #1a1f3a;
        }

        .json-title {
            font-size: 16px;
            font-weight: 600;
            color: #66d9ef;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: calc(100vh - 80px);
            text-align: center;
            color: #75715e;
        }

        .grid-container {
            display: grid;
            gap: 24px;
            padding: 24px;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            align-items: start;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #0a0e27;
        }

        ::-webkit-scrollbar-thumb {
            background: #1a1f3a;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2a2f4a;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #0f1629;
            border: 1px solid #66d9ef;
            color: #e4e7eb;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #0f1629;
            border: 1px solid #1a1f3a;
            border-radius: 8px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
        }

        .modal-textarea {
            width: 100%;
            min-height: 300px;
            background: #1a1f3a;
            border: 1px solid #2a2f4a;
            color: #e4e7eb;
            padding: 12px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            resize: vertical;
        }
    </style>
</head>
<body>
    <!-- Toolbar -->
    <div class="toolbar">
        <input type="file" id="fileInput" accept=".json" multiple style="display: none;">
        <button class="btn btn-primary" onclick="uploadFiles()">üì§ Upload JSON</button>
        <button class="btn btn-secondary" onclick="openPasteModal()">üìù Paste JSON</button>
        <button class="btn btn-secondary" onclick="loadFromBackend()">üåê Load from Backend</button>
        <button class="btn btn-secondary" onclick="exportAll()">üíæ Export All</button>
        <button class="btn btn-secondary" onclick="formatAll()">üé® Format All</button>
        <input type="text" id="searchInput" class="search-input" placeholder="Search keys or values..." oninput="handleSearch(this.value)">
        <span style="color: #75715e; margin-left: auto;">JSONs: <span id="jsonCount">0</span></span>
    </div>

    <!-- Main Content -->
    <div id="mainContent">
        <div class="empty-state" id="emptyState">
            <div style="font-size: 64px; margin-bottom: 20px;">üìã</div>
            <h2 style="color: #66d9ef; margin-bottom: 10px;">No JSON Data Loaded</h2>
            <p style="margin-bottom: 30px;">Upload files, paste JSON, or load from backend to get started</p>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-primary" onclick="uploadFiles()">Upload Files</button>
                <button class="btn btn-secondary" onclick="openPasteModal()">Paste JSON</button>
            </div>
        </div>
        <div class="grid-container" id="gridContainer" style="display: none;"></div>
    </div>

    <!-- Paste Modal -->
    <div class="modal" id="pasteModal">
        <div class="modal-content">
            <h3 style="color: #66d9ef; margin-bottom: 16px;">Paste JSON Data</h3>
            <p style="color: #75715e; margin-bottom: 12px; font-size: 12px;">
                Paste one or multiple JSON objects (separated by newlines)
            </p>
            <textarea id="pasteTextarea" class="modal-textarea" placeholder='{"key": "value"}'></textarea>
            <div style="display: flex; gap: 12px; margin-top: 16px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closePasteModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitPaste()">Add JSON</button>
            </div>
        </div>
    </div>

    <script>
        let jsonDataList = [];
        let searchTerm = '';
        
        // Backend data from FastAPI (if provided)
        const backendData = {{ backend_data | tojson | safe }} || [];
        
        // Initialize with backend data if available
        if (backendData.length > 0) {
            backendData.forEach((item, index) => {
                jsonDataList.push({
                    id: `backend-${Date.now()}-${index}`,
                    name: item.name || `JSON ${index + 1}`,
                    data: item.data || item
                });
            });
            render();
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            if (type === 'error') {
                toast.style.borderColor = '#f92672';
            }
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function uploadFiles() {
            document.getElementById('fileInput').click();
        }

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = e.target.files;
            let added = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                try {
                    const text = await file.text();
                    const parsed = JSON.parse(text);
                    jsonDataList.push({
                        id: `${Date.now()}-${i}`,
                        name: file.name.replace('.json', ''),
                        data: parsed
                    });
                    added++;
                } catch (error) {
                    showToast(`Failed to parse ${file.name}`, 'error');
                }
            }
            
            if (added > 0) {
                showToast(`Added ${added} JSON file${added > 1 ? 's' : ''}`);
                render();
            }
            e.target.value = '';
        });

        function openPasteModal() {
            document.getElementById('pasteModal').classList.add('active');
        }

        function closePasteModal() {
            document.getElementById('pasteModal').classList.remove('active');
            document.getElementById('pasteTextarea').value = '';
        }

        function submitPaste() {
            const text = document.getElementById('pasteTextarea').value.trim();
            if (!text) return;

            const lines = text.split('\n').filter(line => line.trim());
            let added = 0;

            lines.forEach((line, index) => {
                try {
                    const parsed = JSON.parse(line);
                    jsonDataList.push({
                        id: `paste-${Date.now()}-${index}`,
                        name: `JSON ${jsonDataList.length + 1}`,
                        data: parsed
                    });
                    added++;
                } catch (error) {
                    showToast(`Failed to parse line ${index + 1}`, 'error');
                }
            });

            if (added > 0) {
                showToast(`Added ${added} JSON${added > 1 ? 's' : ''}`);
                render();
                closePasteModal();
            }
        }

        async function loadFromBackend() {
            try {
                showToast('Loading from backend...');
                const response = await fetch('/api/jsons');
                const data = await response.json();

                if (!Array.isArray(data)) {
                    showToast('Invalid data format from backend', 'error');
                    return;
                }

                let added = 0;
                data.forEach((item, index) => {
                    jsonDataList.push({
                        id: `backend-${Date.now()}-${index}`,
                        name: item.name || `Backend JSON ${index + 1}`,
                        data: item.data || item
                    });
                    added++;
                });

                showToast(`Loaded ${added} JSON from backend`);
                render();
            } catch (error) {
                showToast('Failed to load from backend', 'error');
            }
        }

        function exportAll() {
            const allData = jsonDataList.map(item => item.data);
            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'all-data.json';
            link.click();
            URL.revokeObjectURL(url);
            showToast('Exported all JSON data');
        }

        function exportSingle(id) {
            const item = jsonDataList.find(j => j.id === id);
            if (!item) return;
            
            const dataStr = JSON.stringify(item.data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${item.name}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showToast(`Exported ${item.name}`);
        }

        function formatAll() {
            showToast('All JSON formatted');
        }

        function deleteJson(id) {
            jsonDataList = jsonDataList.filter(item => item.id !== id);
            showToast('JSON removed');
            render();
        }

        function handleSearch(value) {
            searchTerm = value.toLowerCase();
            render();
        }

        function updateJsonData(id, newData) {
            const item = jsonDataList.find(j => j.id === id);
            if (item) {
                item.data = newData;
                render();
            }
        }

        function render() {
            const emptyState = document.getElementById('emptyState');
            const gridContainer = document.getElementById('gridContainer');
            const jsonCount = document.getElementById('jsonCount');

            jsonCount.textContent = jsonDataList.length;

            if (jsonDataList.length === 0) {
                emptyState.style.display = 'flex';
                gridContainer.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            gridContainer.style.display = 'grid';
            gridContainer.innerHTML = '';

            jsonDataList.forEach(jsonData => {
                const card = document.createElement('div');
                card.className = 'json-card';
                
                const header = document.createElement('div');
                header.className = 'json-header';
                header.innerHTML = `
                    <div class="json-title">${jsonData.name}</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="exportSingle('${jsonData.id}')">üíæ</button>
                        <button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="deleteJson('${jsonData.id}')">üóëÔ∏è</button>
                    </div>
                `;
                
                const content = document.createElement('div');
                content.innerHTML = renderTree(jsonData.data, jsonData.id, '');
                
                card.appendChild(header);
                card.appendChild(content);
                gridContainer.appendChild(card);
            });
        }

        function renderTree(obj, jsonId, path) {
            if (obj === null) {
                return `<span class="json-null">null</span>`;
            }

            const type = typeof obj;
            
            if (type === 'boolean') {
                return `<span class="json-boolean">${obj}</span>`;
            }
            
            if (type === 'number') {
                return `<span class="json-number">${obj}</span>`;
            }
            
            if (type === 'string') {
                const highlight = searchTerm && obj.toLowerCase().includes(searchTerm) ? 'background: rgba(253, 151, 31, 0.2);' : '';
                return `<span class="json-string" style="${highlight}">"${obj}"</span>`;
            }

            if (Array.isArray(obj)) {
                if (obj.length === 0) return '<span>[]</span>';
                
                let html = '<span>[</span><div class="tree-node">';
                obj.forEach((item, index) => {
                    html += `<div><span class="json-key">${index}:</span> ${renderTree(item, jsonId, `${path}[${index}]`)}</div>`;
                });
                html += '</div><span>]</span>';
                return html;
            }

            if (type === 'object') {
                const keys = Object.keys(obj);
                if (keys.length === 0) return '<span>{}</span>';

                let html = '<span>{</span><div class="tree-node">';
                keys.forEach(key => {
                    const keyHighlight = searchTerm && key.toLowerCase().includes(searchTerm) ? 'background: rgba(253, 151, 31, 0.2);' : '';
                    html += `<div><span class="json-key" style="${keyHighlight}">"${key}":</span> ${renderTree(obj[key], jsonId, `${path}.${key}`)}</div>`;
                });
                html += '</div><span>}</span>';
                return html;
            }

            return '';
        }

        // Initialize
        render();

        // Close modal on outside click
        document.getElementById('pasteModal').addEventListener('click', (e) => {
            if (e.target.id === 'pasteModal') {
                closePasteModal();
            }
        });
    </script>
</body>
</html>